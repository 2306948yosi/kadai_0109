<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>企業情報入力</title>
  <link rel="stylesheet" href="kadai.css">
</head>

<header class="header">
  <h1>企業情報</h1>
   <nav>
    <button onclick="location.href='mohan.html'">ES内容</button>
    <button onclick="location.href='mennsetu.html'">面接練習</button>
    <button onclick="location.href='rireki.html'">企業履歴</button>
  </nav>
</header>

  <div class="container">
   <div class="left">
    <div class="card">
    <h2>企業情報入力</h2>

  <form id="entryForm">
    <label>企業名</label>
    <input type="text" id="company" required>
    <label>選考ステータス</label>
    <select id="status">
      <option value="会社説明会">会社説明会</option>
      <option value="ES提出">ES提出</option>
      <option value="一次面接">一次面接</option>
      <option value="二次面接">二次面接</option>
      <option value="最終面接">最終面接</option>
      <option value="選考終了">選考終了</option>
    </select>

    <label>日程</label>
    <input type="datetime-local" id="date">


    <label>メモ</label>
    <textarea id="memo" rows="4"></textarea>

    <button id="save">登録</button>
  </form>
    </div>
   </div> 

   <div class="right">
    <div class="card">
    <h2>間近な企業一覧</h2>
    <div id="list"></div>
    </div>
   </div>   
  </div>


<script>
const form = document.getElementById("entryForm");
const list = document.getElementById("list");

function daysLeft(dateStr) {
  const today = new Date();
  const target = new Date(dateStr);
  return Math.ceil((target - today) / (1000 * 60 * 60 * 24));
}

function getNearestSchedule(items) {
  const future = items
    .filter(i => i.status !== "選考終了" && i.date && daysLeft(i.date) >= 0)
    .sort((a, b) => daysLeft(a.date) - daysLeft(b.date));
  return future[0] ?? null;
}

async function loadCompanies() {
  const res = await fetch("/api/company");
  const data = await res.json();

  list.innerHTML = "";

  const upcoming = []; 

  for (const company in data) {
    const nearest = getNearestSchedule(data[company]);
    if (!nearest) continue;

    const d = daysLeft(nearest.date);

    if (d > 7) continue;

    upcoming.push({
      company,
      status: nearest.status,
      date: nearest.date,
      days: d
    });
  }

  upcoming.sort((a, b) => a.days - b.days);

  for (const item of upcoming) {
    let color = item.days <= 3 ? "red" : "yellow";

    const div = document.createElement("div");
    div.className = `company ${color}`;
    div.innerHTML = `
      <b>${item.company}</b><br>
      ${item.status}：${item.date}<br>
      残り ${item.days} 日
    `;
    list.appendChild(div);
  }

  if (upcoming.length === 0) {
    list.innerHTML = "<p>直近1週間の予定はありません</p>";
  }
}



form.reset();
loadCompanies();

form.addEventListener("submit", async (e) => {
  e.preventDefault();

  await fetch("/api/company", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      company: document.getElementById("company").value,
      status: document.getElementById("status").value,
      date: document.getElementById("date").value,
      memo: document.getElementById("memo").value
    })
  });

  alert("保存しました");
  form.reset();

  loadCompanies();
});

</script>
