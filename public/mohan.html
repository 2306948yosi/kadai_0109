<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ES管理</title>
  <style>
    body { max-width: 800px; margin: 30px auto; font-family: sans-serif; }
    textarea, input, button { width: 100%; margin-top: 10px; }
    textarea { height: 150px; }
    .entry { background: #f5f5f5; padding: 15px; margin-top: 15px; }
    .count { text-align: right; color: #666; }
  </style>
</head>
<body>

<h1>ES管理</h1>

<input id="title" placeholder="タイトル">
<textarea id="text"></textarea>
<div class="count" id="count">0文字</div>

<button id="save">保存</button>
<button id="update" style="display:none;">更新</button>

<hr>
<h2>これまでのES</h2>
<div id="list"></div>

<script>
const titleInput = document.getElementById("title");
const textInput = document.getElementById("text");
const count = document.getElementById("count");
const list = document.getElementById("list");
const saveBtn = document.getElementById("save");
const updateBtn = document.getElementById("update");

let editTitle = null;
let editIndex = null;

textInput.addEventListener("input", () => {
  count.innerText = textInput.value.length + "文字";
});

// 保存（新規）
saveBtn.onclick = async () => {
  await fetch("/api/es", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      title: titleInput.value,
      text: textInput.value
    })
  });

  resetForm();
  loadES();
};

// 更新
updateBtn.onclick = async () => {
  await fetch("/api/es/update", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      title: editTitle,
      index: editIndex,
      text: textInput.value
    })
  });

  resetForm();
  loadES();
};

function resetForm() {
  titleInput.value = "";
  textInput.value = "";
  count.innerText = "0文字";
  saveBtn.style.display = "block";
  updateBtn.style.display = "none";
}

async function loadES() {
  const res = await fetch("/api/es");
  const data = await res.json();
  list.innerHTML = "";

  for (const title in data) {
    data[title].forEach((item, index) => {
      const div = document.createElement("div");
      div.className = "entry";
      div.innerHTML = `
        <b>${title}</b>
        <p>${item.text}</p>
        <div class="count">${item.count}文字</div>
        <button onclick="editES('${title}', ${index})">編集</button>
        <button onclick="deleteES('${title}', ${index})">削除</button>
      `;
      list.appendChild(div);
    });
  }
}

window.editES = (title, index) => {
  fetch("/api/es")
    .then(res => res.json())
    .then(data => {
      titleInput.value = title;
      textInput.value = data[title][index].text;
      count.innerText = data[title][index].count + "文字";

      editTitle = title;
      editIndex = index;

      saveBtn.style.display = "none";
      updateBtn.style.display = "block";
    });
};

window.deleteES = async (title, index) => {
  await fetch("/api/es/delete", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ title, index })
  });
  loadES();
};

loadES();
</script>

</body>
</html>